{{extend 'layout.html'}}

<h1>{{=T('Statistics')}}</h1>

<button type="button" class="btn btn-info" data-toggle="collapse" data-target="#form">{{=T('New')}}</button>
<div id="form" class="collapse {{if request.args(1) or form.errors:}}in{{pass}}">
  {{=form}}
</div>

<div style="float:right">
  {{=A(T('activate'), _href=URL('engine', 'activate_stats', args=client.id), _class="btn btn-danger")}}
</div>

<table class="table">
  <thead>
    <tr>
      <th>{{=T('Name')}}</th>
      <th>{{=T('Queue Length')}}</th>
      <th>{{=T('Time window')}}</th>
      <th>{{=T('Save interval')}}</th>
      <th>{{=T('Metrics')}}</th>
      <th>{{=T('Filter')}}</th>
      <th>{{=T('Triggers')}}</th>
      <th>{{=T('Status')}}</th>
    </tr>
  </thead>
  <tbody>
    {{for st in stats:}}
    <tr>
      <td>{{=st.name}}</td>
      <td>{{=st.queue_length}}</td>
      <td>{{=st.time_window}}</td>
      <td>{{=st.save_interval}}</td>
      <td>{{=', '.join(st.metrics)}}</td>
      <td>{{=st.stats_filter}}</td>
      <td>{{=', '.join(st.triggers)}}</td>
      <td>{{=st.status}}</td>
      <td>
	<div class="btn-group"  role="group" aria-label="actions">
	  {{=A(T('edit'), _href=URL('default', 'stats', args=(st.client.id, st.id)), _class="btn btn-link")}}
	</div>
      </td>
    </tr>
    {{pass}}
  </tbody>
</table>

<h2>{{=T('Graphs')}}</h2>

{{for st in stats:}}
<h3>{{=st.name}}</h3>
<table class="table">
  <thead>
    <tr>
      <th>{{=T('Metric')}}</th>
      <th>{{=T('Value')}}</th>
    </tr>
  </thead>
  <tbody>
    {{for metric in st.metrics:}}
    <tr>
      <td>{{=metric}}</td>
      <td id="{{='%s_%s' %(st.name, metric)}}"></td>
    </tr>
    {{pass}}
  </tbody>
</table>
{{pass}}

{{block page_js}}
<script type="text/javascript">
 $(function() {
   var updateInterval = 3500;
   function getData() {
     $.ajax({
       url: "http://localhost:8000/engine/metrics.json/{{=client.id}}",
       type: "GET",
       dataType: "json",
       success: function(queue) {
	 {{for st in stats:}}
	 {{for metric in st.metrics:}}
	 $('#{{="%s_%s" %(st.name, metric)}}').text(format_metric('{{=metric}}', queue['{{=st.name}}']['{{=metric}}']));
	 {{pass}}
	 {{pass}}
       }
     });
     return ;
   }

   function format_metric(metric, value){
     if(['ACD', 'TCD'].indexOf(metric) > -1){
       return (value/60).toFixed(2) + 'm';
     }
     if(['ASR'].indexOf(metric) > -1){
       return value + '%';
     }
     return value;
   }

   function update() {
     getData();
     setTimeout(update, updateInterval);
   }

   update();
   });
</script>
{{end page_js}}
